<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة منتج إلى المخزن</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        .product-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>إضافة منتج جديد إلى المخزن</h1>

    <!-- الحقول المطلوبة -->
    <label>اسم المنتج:</label>
    <input type="text" id="productName"><br><br>

    <label>سعر المنتج:</label>
    <input type="number" id="productPrice"><br><br>

    <label>كمية المنتج:</label>
    <input type="number" id="productQuantity"><br><br>

    <!-- زر الإضافة -->
    <button onclick="addProduct()">إضافة المنتج</button>
    <button id="toggleButton" onclick="toggleProducts()">عرض جميع المنتجات</button>

    <!-- لودر التحميل -->
    <p id="loader" style="display:none;">تحميل...</p>

    <!-- رسالة النجاح -->
    <p id="successMessage" style="display:none;">تم إضافة المنتج إلى المخزن بنجاح</p>

    <!-- عرض جميع المنتجات -->
    <div id="productsList" style="display:none;"></div>

    <script>
        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCPpTAJDRfFuDkq2TGCVIU_LnmYRBXTnSc",
            authDomain: "new-protfolio.firebaseapp.com",
            databaseURL: "https://new-protfolio-default-rtdb.firebaseio.com",
            projectId: "new-protfolio",
            storageBucket: "new-protfolio.appspot.com",
            messagingSenderId: "90141039664",
            appId: "1:90141039664:web:44d13d2f3b943f510aa1f5"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const productsRef = database.ref('products');

        // دالة لإضافة المنتج إلى قاعدة البيانات
        function addProduct() {
            // إخفاء رسالة النجاح
            document.getElementById('successMessage').style.display = 'none';

            // عرض لودر التحميل
            document.getElementById('loader').style.display = 'block';

            // الحصول على بيانات المنتج
            const productName = document.getElementById('productName').value;
            const productPrice = document.getElementById('productPrice').value;
            const productQuantity = document.getElementById('productQuantity').value;

            // التحقق من صحة البيانات
            if (productName === "" || productPrice === "" || productQuantity === "") {
                alert("من فضلك أدخل جميع البيانات.");
                document.getElementById('loader').style.display = 'none';
                return;
            }

            // تحديد الـ ID للمنتج الجديد
            productsRef.once('value').then((snapshot) => {
                let nextId = 1;
                snapshot.forEach(childSnapshot => {
                    const childId = parseInt(childSnapshot.key);
                    if (childId >= nextId) {
                        nextId = childId + 1;
                    }
                });

                const productId = nextId.toString().padStart(3, '0'); // ID يبدأ من 001

                // إضافة المنتج إلى قاعدة البيانات
                productsRef.child(productId).set({
                    name: productName,
                    price: productPrice,
                    quantity: productQuantity,
                    timestamp: new Date().toISOString() // إضافة الوقت والتاريخ
                }, function(error) {
                    // إخفاء لودر التحميل
                    document.getElementById('loader').style.display = 'none';

                    if (error) {
                        alert("حدث خطأ أثناء إضافة المنتج.");
                    } else {
                        // عرض رسالة النجاح
                        document.getElementById('successMessage').style.display = 'block';

                        // مسح الحقول بعد الإضافة
                        document.getElementById('productName').value = "";
                        document.getElementById('productPrice').value = "";
                        document.getElementById('productQuantity').value = "";
                    }
                });
            });
        }

        // دالة لتحميل المنتجات وعرضها
        function loadProducts() {
            const productsListDiv = document.getElementById('productsList');
            productsListDiv.innerHTML = ""; // مسح القائمة السابقة

            // عرض لودر التحميل
            document.getElementById('loader').style.display = 'block';

            productsRef.once('value', (snapshot) => {
                // إخفاء لودر التحميل
                document.getElementById('loader').style.display = 'none';

                snapshot.forEach(childSnapshot => {
                    const product = childSnapshot.val();
                    const productId = childSnapshot.key;

                    const productItem = document.createElement('div');
                    productItem.className = 'product-item';
                    productItem.innerHTML = `
                        <h3>${product.name}</h3>
                        <p>السعر: ${product.price}</p>
                        <p>الكمية: ${product.quantity}</p>
                        <p>تاريخ الإضافة: ${new Date(product.timestamp).toLocaleString()}</p>
                        <button onclick="editProduct('${productId}')">تعديل</button>
                        <button onclick="deleteProduct('${productId}')">حذف</button>
                    `;
                    productsListDiv.appendChild(productItem);
                });
            });
        }

        // دالة لتعديل المنتج
        function editProduct(productId) {
            const productRef = productsRef.child(productId);

            productRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const productData = snapshot.val();

                    // ملء الحقول بالبيانات الحالية للمنتج
                    document.getElementById('productName').value = productData.name;
                    document.getElementById('productPrice').value = productData.price;
                    document.getElementById('productQuantity').value = productData.quantity;

                    // تغيير الزر لإجراء التحديث
                    const addButton = document.querySelector('button[onclick="addProduct()"]');
                    addButton.onclick = function() {
                        updateProduct(productId);
                    };
                } else {
                    alert("المنتج غير موجود.");
                }
            });
        }

        // دالة لتحديث المنتج
        function updateProduct(productId) {
            const productName = document.getElementById('productName').value;
            const productPrice = document.getElementById('productPrice').value;
            const productQuantity = document.getElementById('productQuantity').value;

            // التحقق من صحة البيانات
            if (productName === "" || productPrice === "" || productQuantity === "") {
                alert("من فضلك أدخل جميع البيانات.");
                return;
            }

            // تحديث البيانات في قاعدة البيانات
            productsRef.child(productId).update({
                name: productName,
                price: productPrice,
                quantity: productQuantity,
                timestamp: new Date().toISOString() // تحديث الوقت والتاريخ
            }, function(error) {
                if (error) {
                    alert("حدث خطأ أثناء تحديث المنتج.");
                } else {
                    alert("تم تحديث المنتج بنجاح.");
                    // مسح الحقول بعد التحديث
                    document.getElementById('productName').value = "";
                    document.getElementById('productPrice').value = "";
                    document.getElementById('productQuantity').value = "";

                    // إعادة الزر إلى وظيفته الأصلية
                    const addButton = document.querySelector('button[onclick="addProduct()"]');
                    addButton.onclick = addProduct;

                    // إعادة تحميل المنتجات
                    loadProducts();
                }
            });
        }

        // دالة لحذف المنتج
        function deleteProduct(productId) {
            if (confirm("هل أنت متأكد أنك تريد حذف هذا المنتج؟")) {
                productsRef.child(productId).remove()
                    .then(() => {
                        alert("تم حذف المنتج بنجاح.");
                        loadProducts(); // إعادة تحميل المنتجات بعد الحذف
                    })
                    .catch((error) => {
                        alert("حدث خطأ أثناء حذف المنتج.");
                    });
            }
        }

        // دالة لتبديل عرض جميع المنتجات
        function toggleProducts() {
            const productsListDiv = document.getElementById('productsList');
            if (productsListDiv.style.display === "none") {
                loadProducts(); // تحميل المنتجات عند إظهار القائمة
                productsListDiv.style.display = "block";
                document.getElementById('toggleButton').innerText = "إخفاء جميع المنتجات";
                
                // الاستماع للتغييرات في قاعدة البيانات
                productsRef.on('child_added', (data) => {
                    const product = data.val();
                    const productId = data.key;

                    const productItem = document.createElement('div');
                    productItem.className = 'product-item';
                    productItem.innerHTML = `
                        <h3>${product.name}</h3>
                        <p>السعر: ${product.price}</p>
                        <p>الكمية: ${product.quantity}</p>
                        <p>تاريخ الإضافة: ${new Date(product.timestamp).toLocaleString()}</p>
                        <button onclick="editProduct('${productId}')">تعديل</button>
                        <button onclick="deleteProduct('${productId}')">حذف</button>
                    `;
                    productsListDiv.appendChild(productItem);
                });
            } else {
                productsListDiv.style.display = "none";
                document.getElementById('toggleButton').innerText = "عرض جميع المنتجات";

                // إلغاء الاستماع للتغييرات عند إخفاء القائمة
                productsRef.off('child_added');
            }
        }
    </script>
</body>
</html>
